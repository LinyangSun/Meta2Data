#!/bin/bash
set -e

# Find scripts directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
SCRIPTS="${SCRIPT_DIR}/scripts/MetaDL"

show_help() {
    cat << EOF
Usage: Meta2Data MetaDL [options]

Search and download metadata from NCBI and CNCB/GSA for BioProjects.
Supports both NCBI (PRJNA/PRJEB/PRJDB) and CNCB/GSA (PRJCA) databases.
Downloads and merges metadata automatically.

Required options:
    -i, --input DIR           Input directory containing BioProject ID txt files
    -o, --output DIR          Output directory for metadata
    -e, --email EMAIL         Email address (required by NCBI)

Optional options:
    -h, --help                Show this help message

Input Format:
    The input directory should contain .txt files with BioProject IDs.
    Each file should have one BioProject ID per line.
    Supported formats: PRJNA*, PRJEB*, PRJDB* (NCBI), PRJCA* (CNCB/GSA)

Output Files:
    NCBI (PRJNA/PRJEB/PRJDB):
      - *_biosample.txt              Raw BioSample data
      - *_sra_runinfo.csv            Raw SRA RunInfo
      - ncbi_merged_*.csv            Merged NCBI data

    CNCB/GSA (PRJCA):
      - *.xlsx                       Raw Excel metadata
      - cncb_combined.csv            Combined CNCB data

    Final:
      - all_metadata_merged.csv      Merged NCBI + CNCB data

Example:
    # Download metadata for BioProjects in bioproject_ids/ folder
    Meta2Data MetaDL -i bioproject_ids/ -o metadata_output/ -e your@email.com

    # Or use full paths
    Meta2Data MetaDL \\
        --input /path/to/bioproject_ids/ \\
        --output /path/to/output/ \\
        --email researcher@university.edu

Workflow:
    1. Read and classify BioProject IDs (NCBI vs CNCB)
    2. Download NCBI data (BioSample + SRA) for PRJNA/PRJEB/PRJDB
    3. Download CNCB data (Excel) for PRJCA
    4. Merge NCBI data (SRA + BioSample)
    5. Convert CNCB Excel to CSV
    6. Final merge: Combine NCBI and CNCB datasets

Note:
    - NCBI requires an email address for API access
    - Large datasets may take significant time to download
    - The script includes automatic retry and error handling

EOF
}

# Default parameters
INPUT=""
OUTPUT=""
EMAIL=""

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -i|--input)
            INPUT="$2"
            shift 2
            ;;
        -o|--output)
            OUTPUT="$2"
            shift 2
            ;;
        -e|--email)
            EMAIL="$2"
            shift 2
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            echo "Error: Unknown option '$1'"
            show_help
            exit 1
            ;;
    esac
done

# Validate required parameters
if [[ -z "$INPUT" ]]; then
    echo "Error: --input is required"
    show_help
    exit 1
fi

if [[ -z "$OUTPUT" ]]; then
    echo "Error: --output is required"
    show_help
    exit 1
fi

if [[ -z "$EMAIL" ]]; then
    echo "Error: --email is required (NCBI requirement)"
    show_help
    exit 1
fi

# Check if input directory exists
if [[ ! -d "$INPUT" ]]; then
    echo "Error: Input directory '$INPUT' not found"
    exit 1
fi

# Check if input directory contains txt files
txt_count=$(find "$INPUT" -maxdepth 1 -name "*.txt" | wc -l)
if [[ $txt_count -eq 0 ]]; then
    echo "Error: No .txt files found in input directory '$INPUT'"
    echo "Please provide BioProject IDs in .txt files (one ID per line)"
    exit 1
fi

# Create output directory
mkdir -p "$OUTPUT"

# Log parameters
echo "=== Meta2Data MetaDL ==="
echo "Input directory:  $INPUT"
echo "Output directory: $OUTPUT"
echo "Email:            $EMAIL"
echo "BioProject files: $txt_count"
echo "=========================="
echo ""

# Call the unified Python script (supports both NCBI and CNCB)
python3 "${SCRIPTS}/unified_metadata_downloader.py" \
    --input "$INPUT" \
    --output "$OUTPUT" \
    --email "$EMAIL"

EXIT_CODE=$?

if [[ $EXIT_CODE -eq 0 ]]; then
    echo ""
    echo "==========================="
    echo "MetaDL completed successfully!"
    echo "==========================="
    echo ""
    echo "Output files are in: $OUTPUT"
    echo ""
    echo "Main output file:"
    echo "  - all_metadata_merged.csv (merged NCBI + CNCB metadata)"
    echo ""
else
    echo ""
    echo "==========================="
    echo "MetaDL failed with exit code $EXIT_CODE"
    echo "==========================="
    exit $EXIT_CODE
fi
